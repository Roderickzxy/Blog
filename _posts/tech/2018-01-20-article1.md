---
layout: post
title:  "搭建redis集群"
crawlertitle: "搭建redis集群"
summary: "在linux上搭建redis集群"
date:   2018-01-20 11:20:56 +0700
cataname: 积累，等待，蜕变
category: tech/2018-01-20
tags: 'tech-Redis'
author: Roderick
---
由于本人的硬件条件限制，所以这里不演示多台主机搭建集群的方式，而是采用一台主机，多个redis服务以不同端口号来模拟多个主机运行redis服务。

操作系统环境：ubuntu 16.04  
redis版本：redis 3.2.9  
### 1.安装编译redis： ###  
{% highlight shell %}
roderick@ubuntu:/development$ wget http://download.redis.io/releases/redis-3.2.9.tar.gz  
roderick@ubuntu:/development$ tar -zxvf redis-3.2.9.tar.gz　  
roderick@ubuntu:/development$ cd redis-3.2.9
roderick@ubuntu:/development/redis-3.2.9$ make && make install
{% endhighlight %}  
安装完后在src目录下调用redis-server就启动redis服务了，默认端口是6379.  
### 2.创建不同端口号的Redis节点 ###
假如想要启动不同端口的服务，需要修改配置文件，并且调用redis-server时指定配置文件就行了。  
将配置文件拷贝6份（搭建一个集群至少需要6个节点）到自定义的文件夹里：  
[![attache1]({{ site.article_attachedimages | relative_url }}/tech/article3-attache1.jpg)]({{ site.article_attachedimages | relative_url }}/article3-attache1.jpg)  
然后分别修改这6个配置文件：
{% highlight shell %}
port  6379                                     //端口6379,6378,6377,6376,6375,6374          
bind 本机ip                                    //默认ip为127.0.0.1 需要改为其他节点机器可访问的ip 否则创建集群时无法访问对应的端口，无法创建集群  
daemonize    yes                              //redis后台运行  
pidfile  /var/run/redis_6379.pid              //pidfile文件对应6379,6378,6377,6376,6375,6374  
cluster-enabled  yes                          //开启集群  把注释#去掉  
cluster-config-file  nodes_6379.conf          //集群的配置  配置文件首次启动自动生成 6379,6378,6377,6376,6375,6374   
cluster-node-timeout  15000                   //请求超时  默认15秒，可自行设置  
appendonly  yes                               //aof日志开启  有需要就开启，它会每次写操作都记录一条日志　
{% endhighlight %}   
启动各个不同端口的节点服务：
{% highlight shell %}
roderick@ubuntu:/development/redis-3.2.9/src$ ./redis-server ../test-cluster/redis-6379.conf  
roderick@ubuntu:/development/redis-3.2.9/src$ ./redis-server ../test-cluster/redis-6378.conf
roderick@ubuntu:/development/redis-3.2.9/src$ ./redis-server ../test-cluster/redis-6377.conf  
roderick@ubuntu:/development/redis-3.2.9/src$ ./redis-server ../test-cluster/redis-6376.conf  
roderick@ubuntu:/development/redis-3.2.9/src$ ./redis-server ../test-cluster/redis-6375.conf  
roderick@ubuntu:/development/redis-3.2.9/src$ ./redis-server ../test-cluster/redis-6374.conf     
{% endhighlight %}  
查看所有服务：
{% highlight shell %}
roderick@ubuntu:/development/redis-3.2.9/src$ ps -fe | grep 'redis'
roderick  62601   1833  0 04:43 ?        00:00:00 ./redis-server 192.168.85.130:6378 [cluster]  
roderick  62609   1833  0 04:43 ?        00:00:00 ./redis-server 192.168.85.130:6379 [cluster]  
roderick  62816   1833  0 04:50 ?        00:00:00 ./redis-server 192.168.85.130:6377 [cluster]  
roderick  63095   1833  0 05:00 ?        00:00:00 ./redis-server 192.168.85.130:6376 [cluster]  
roderick  63101   1833  0 05:00 ?        00:00:00 ./redis-server 192.168.85.130:6375 [cluster]  
roderick  63109   1833  0 05:00 ?        00:00:00 ./redis-server 192.168.85.130:6374 [cluster]   
roderick  63145  61806  0 05:02 pts/19   00:00:00 grep --color=auto redis  
{% endhighlight %}  
启动好所有服务后，再调用redis-trib.rb指定主机就搭建起集群了。但是这个脚本需要用到ruby的语法，因此需要安装ruby环境。  
### 3.安装ruby环境 ###
{% highlight shell %}
roderick@ubuntu:/development$ sudo apt-get install ruby  
roderick@ubuntu:/development$ ruby -v  
ruby 2.3.1p112 (2016-04-26) [x86_64-linux-gnu]
{% endhighlight %}  
### 4.运行redis-trib.rb指定集群的主机与端口号 ###
{% highlight shell %}
roderick@ubuntu:/development/redis-3.2.9/src$ ./redis-trib.rb  create  --replicas  1  192.168.85.130:6379 192.168.85.130:6378 192.168.85.130:6377 192.168.85.130:6376 192.168.85.130:6375 192.168.85.130:6374
>>> Creating cluster
>>> Performing hash slots allocation on 6 nodes...
Using 3 masters:
192.168.85.130:6379
192.168.85.130:6378
192.168.85.130:6377
Adding replica 192.168.85.130:6376 to 192.168.85.130:6379
Adding replica 192.168.85.130:6375 to 192.168.85.130:6378
Adding replica 192.168.85.130:6374 to 192.168.85.130:6377
M: 75a2ad178da91193cc64de911d49149168ed5b8a 192.168.85.130:6379
   slots:0-5460 (5461 slots) master
M: 5df12338bc77a459605c1ea8a46032981249a677 192.168.85.130:6378
   slots:5461-10922 (5462 slots) master
M: 1da1365a6fc0c2d4b0b565d2a8da7e68bbeac8bd 192.168.85.130:6377
   slots:10923-16383 (5461 slots) master
S: acb47d982427aed323719cfd2ade537e07e88e4a 192.168.85.130:6376
   replicates 75a2ad178da91193cc64de911d49149168ed5b8a
S: 7ff8f87fd1e9f718f917ad1843c6babb049d191d 192.168.85.130:6375
   replicates 5df12338bc77a459605c1ea8a46032981249a677
S: 08bbf916fb11042f7f5cca0354d2c4812a786d3e 192.168.85.130:6374
   replicates 1da1365a6fc0c2d4b0b565d2a8da7e68bbeac8bd
Can I set the above configuration? (type 'yes' to accept): yes
>>> Nodes configuration updated
>>> Assign a different config epoch to each node
>>> Sending CLUSTER MEET messages to join the cluster
Waiting for the cluster to join....
>>> Performing Cluster Check (using node 192.168.85.130:6379)
M: 75a2ad178da91193cc64de911d49149168ed5b8a 192.168.85.130:6379
   slots:0-5460 (5461 slots) master
   1 additional replica(s)
S: acb47d982427aed323719cfd2ade537e07e88e4a 192.168.85.130:6376
   slots: (0 slots) slave
   replicates 75a2ad178da91193cc64de911d49149168ed5b8a
S: 08bbf916fb11042f7f5cca0354d2c4812a786d3e 192.168.85.130:6374
   slots: (0 slots) slave
   replicates 1da1365a6fc0c2d4b0b565d2a8da7e68bbeac8bd
M: 1da1365a6fc0c2d4b0b565d2a8da7e68bbeac8bd 192.168.85.130:6377
   slots:10923-16383 (5461 slots) master
   1 additional replica(s)
M: 5df12338bc77a459605c1ea8a46032981249a677 192.168.85.130:6378
   slots:5461-10922 (5462 slots) master
   1 additional replica(s)
S: 7ff8f87fd1e9f718f917ad1843c6babb049d191d 192.168.85.130:6375
   slots: (0 slots) slave
   replicates 5df12338bc77a459605c1ea8a46032981249a677
[OK] All nodes agree about slots configuration.
>>> Check for open slots...
>>> Check slots coverage...
[OK] All 16384 slots covered.
{% endhighlight %}   
可以看到集群启动成功了。
### 5.运行redis客户端连接集群 ###
{% highlight shell %}
roderick@ubuntu:/development/redis-3.2.9/src$ ./redis-cli -h 192.168.85.130 -p 6379 -c  
192.168.85.130:6379> get test  
-> Redirected to slot [6918] located at 192.168.85.130:6378  
(nil)  
192.168.85.130:6378> get test  
"\xac\xed\x00\x05t\x00\x0cIamthebatman"  
{% endhighlight %}   